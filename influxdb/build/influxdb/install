#!/usr/bin/env bash

INFLUXDB_VERSION=0.8.5

curl -s -o /tmp/influxdb_amd64.deb https://s3.amazonaws.com/influxdb/influxdb_${INFLUXDB_VERSION}_amd64.deb
dpkg -i /tmp/influxdb_amd64.deb

rm /tmp/influxdb_amd64.deb

PRE_CREATE_DB="instance_metrics"

if [ -n "${PRE_CREATE_DB}" ]; then
    echo "=> About to create the following databases: ${PRE_CREATE_DB}"

    echo "=> Starting InfluxDB ..."
    exec /usr/bin/influxdb -config=/etc/influxdb/config.toml &
    arr=$(echo ${PRE_CREATE_DB} | tr ";" "\n")

    #wait for the startup of influxdb
    RET=1
    while [[ RET -ne 0 ]]; do
        echo "=> Waiting for confirmation of InfluxDB service startup ..."
        sleep 3
        curl -k http://localhost:8086/ping 2> /dev/null
        RET=$?
    done

    for x in $arr
    do
        echo "=> Creating database: ${x}"
        curl -X POST 'http://localhost:8086/db?u=root&p=root' -d "{\"name\":\"${x}\"}"
        curl -X POST "http://localhost:8086/db/${x}/users?u=root&p=root" -d '{"name": "user", "password": "user"}'
        curl -X POST "http://localhost:8086/db/${x}/users/user?u=root&p=root" -d '{"admin": true}'
    done
else
    echo "=> No database need to be pre-created"
fi
